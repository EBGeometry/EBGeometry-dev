name: clang-tidy-review

on:
  pull_request:
#    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: ${{ github.ref }}-${{ github.head_ref }}-clang-tidy
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write  

jobs:
  clang-tidy:
    if: ${{ !github.event.pull_request_draft }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Generate dummy translation unit for headers
        run: |
          mkdir -p build/tools
          cat > build/tools/clang_tidy_all.cpp <<'EOF'
          #include "EBGeometry.hpp"
          EOF

      - name: Configure (CMake) to generate compile_commands.json
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          cat >> CMakeLists.txt <<'EOF'
          add_library(clang_tidy_headers OBJECT build/tools/clang_tidy_all.cpp)
          target_include_directories(clang_tidy_headers PRIVATE ${CMAKE_SOURCE_DIR})
          EOF
          cmake --build build -j 2 || true

      # Run clang-tidy and post a review on the PR
      - name: Clang-Tidy Review
        uses: ZedThree/clang-tidy-review@4ea7f7b72e7e039588ef5e64de9a845e5a3f8db5 # v0.21.0
        with:
          build_dir: build
          clang_tidy_checks: ''      
          lgtm_comment_body: ''      
          annotations: true


        # Uploads an artefact containing clang_fixes.json
        - uses: ZedThree/clang-tidy-review/upload@4ea7f7b72e7e039588ef5e64de9a845e5a3f8db5 # v0.21.0

        # If there are any comments, fail the check
        - if: steps.review.outputs.total_comments > 0
          run: exit 1
